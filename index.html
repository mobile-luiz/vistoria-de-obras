<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vistoria de obras</title>

    <link rel="icon" href="poste_transparente.png" type="image/png" />

    <link rel="stylesheet" href="estilos.css" />

</head>

<body>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2>Login</h2>
            <input type="text" id="loginEmail" placeholder="E-mail ou Usu√°rio" />
            <input type="password" id="loginSenha" placeholder="Senha" />
            <button onclick="fazerLogin()">Entrar</button>
            <div id="loginErro" class="login-erro"></div>
            
            <div class="login-logo-container">
                <img src="poste_transparente.png" alt="Logo" class="login-logo" />
                <h3 class="login-title">Vistoria de obras</h3>
            </div>
        </div>
    </div>

    <div id="sistemaContainer" class="sistema-container">
        <div id="mainContent" class="container">
            <div id="pdfContainer">
                <div class="top-bar">
                    <h2>Vistoria de obras</h2>
                    <img src="poste_transparente.png" alt="Logo Atbuilt" class="site-logo" />
                </div>

                <div class="header">
                    <div>
                        <label for="usuario">E-mail do usu√°rio</label>
                        <input type="text" id="usuario" oninput="filtrarPostes()" placeholder="Filtrar por usu√°rio" />
                    </div>

                    <div>
                        <label for="filtroProjeto">ID do Projeto</label>
                        <input
                            type="text"
                            id="filtroProjeto"
                            oninput="filtrarPostes()"
                            placeholder="Filtrar por ID do Projeto"
                        />
                    </div>

                    <div>
                        <label for="filtroPoste">C√≥digo do Poste</label>
                        <input
                            type="text"
                            id="filtroPoste"
                            oninput="filtrarPostes()"
                            placeholder="Filtrar por c√≥digo"
                        />
                    </div>

                    <div>
                        <label for="filtroStatus">Status</label>
                        <select id="filtroStatus" onchange="filtrarPostes()">
                            <option value="">Todos</option>
                            <option value="em andamento">Em andamento</option>
                            <option value="conclu√≠do">Conclu√≠do</option>
                        </select>
                    </div>

                    <div>
                        <label for="dataInicial">De:</label>
                        <input type="date" id="dataInicial" onchange="filtrarPostes()" />
                    </div>
                    <div>
                        <label for="dataFinal">At√©:</label>
                        <input type="date" id="dataFinal" onchange="filtrarPostes()" />
                    </div>
                </div>

                <div class="acoes">
                    <button id="btnPowerBI" onclick="togglePowerBI()">üìä Power BI</button>
                    <button id="btnMostrarPodas" onclick="togglePodas()">üåø Mostrar Podas</button>
                    
                </div>
                
                <div id="contadorStatus"></div>

                <div id="paginacao"></div>

                <div class="scroll-table">
                    <table id="tabelaPostes">
                        <thead>
                            <tr>
                                <th>Vistoria</th>
                                <th>Projeto</th>
                                <th>Refer√™ncia el√©trica</th>
                                <th>Acesso</th>
                                <th>Bra√ßo</th>
                                <th>Estrutura Secund√°ria</th>
                                <th>Linha Viva</th>
                                <th>Poda faixa</th>
                                <th>Observa√ß√µes</th>
                                <th>Apta Execu√ß√£o</th>
                                <th>Cava Rocha</th>
                                <th>LM</th>
                                <th>Retroescavadeira</th>
                                <th>Lat</th>
                                <th>Lng</th>
                                <th>Usu√°rio</th>
                                <th>Vistoriador</th>
                                <th>CPF Morador</th>
                                <th>Fone Morador</th>
                                <th>Lumin√°ria</th>
                                <th>Funda√ß√£o Especial</th>
                                <th>Guard Rail</th>
                                <th>Obra LPT</th>
                                <th>Monof√°sico</th>
                                <th>Bif√°sico</th>
                                <th>Trif√°sico</th>
                                <th>Desligamento</th>
                                <th>Qtd Ramais</th>
                                <th>Tempo decorrido</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                                <th>Excluir</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3 class="map-title">üìç Mapa dos Postes</h3>
                <div class="map-legend-item">
                    <div style="display: flex; align-items: center;">
                        <span class="legend-color-box legend-em-andamento"></span>
                        Em andamento
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span class="legend-color-box legend-concluido"></span>
                        Conclu√≠do
                    </div>
                </div>
                <div id="map" class="mapa-container"></div> 
                </div>
            </div>
        <div id="powerbiContainer" style="display: none; width: 100%; height: 80vh; position: relative;">
            <button
                onclick="togglePowerBI()"
                style="position: absolute; top: 16px; right: 16px; z-index: 10;
                      background: #1e88e5; color: #fff; border: none; padding: 8px 12px;
                      border-radius: 4px; cursor: pointer;"
            >
                ‚Üê Voltar ao Painel
            </button>
    </button>

   <iframe
  title="Atbuilt atual"
  width="100%"
  height="100%"
  src="https://app.powerbi.com/view?r=eyJrIjoiNDcwY2RlNDUtYjA1Ni00OTUzLTkyNzUtNGM2YWI3ZjdlOTM4IiwidCI6ImMyNGEyNGRjLWJjYTAtNGYyYS1hOTRmLWY3NDVkNDdkZTE4MCJ9"
  frameborder="0"
  allowFullScreen="true"
  style="border: none;"
></iframe>
    </div>
    <!-- fim #powerbiContainer -->
  </div>
  <!-- fim #sistemaContainer -->

  <!-- initMap para Google Maps -->
  <script>
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -8.0, lng: -35.0 },
        zoom: 6,
        gestureHandling: "greedy",
        zoomControl: true,
        mapTypeControl: true,
        streetViewControl: false,
        fullscreenControl: true,
      });
    }
  </script>
 
 
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNfO72QTnIMEn2g743sO_5UR5o-2KmEig&callback=initMap"
    async defer>
  </script>
  <script src="https://cdn.jsdelivr.net/npm/google-maps-utility-library-v3-infobox@latest/infobox.min.js"></script>

<script>
    // ---------- Inicializa√ß√£o Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCZEXr0laF1lT2_99m-c9esufO3Mpl5mXg",
      databaseURL: "https://vistoria-obras-default-rtdb.firebaseio.com",
      // ... outras configura√ß√µes
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let todosOsPostes = [];
    let listaVisivel = [];
    let paginaAtual = 1;
    const itensPorPagina = 100;
    let map;
    let markers = [];
    // VARI√ÅVEL DE LINHA VIVA REMOVIDA
    let mostrandoSomentePodas = false; 

    // ---------- Calcular Tempo Decorrido (dias e horas) ----------
    function calcularTempoDecorrido(dataLancStr) {
      if (!dataLancStr) return null;
      // Se dataLancStr estiver no formato "DD/MM/YYYY HH:mm:ss":
      const partes = dataLancStr.split(/[\s/:]+/).map(Number);
      const dataLanc = new Date(partes[2], partes[1] - 1, partes[0], partes[3], partes[4], partes[5] || 0);
      const agora = new Date();
      const diffMs = agora - dataLanc;
      if (isNaN(diffMs) || diffMs < 0) return null;
      const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const horas = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      return { dias, horas };
    }

    // ---------- Fun√ß√£o de Login ----------
    function fazerLogin() {
      const email = document.getElementById("loginEmail").value.trim();
      const senha = document.getElementById("loginSenha").value.trim();
      if (!email || !senha) {
        document.getElementById("loginErro").innerText = "Por favor, preencha e-mail e senha.";
        return;
      }
      auth.signInWithEmailAndPassword(email, senha)
        .then(() => {
          document.getElementById("loginContainer").style.display = "none";
          document.getElementById("sistemaContainer").style.display = "block";
          carregarPostes();
        })
        .catch(err => {
          document.getElementById("loginErro").innerText = `Erro: ${err.message}`;
        });
    }

    function gerarRelatorioSintetico() {
      window.location.href = "relatorios.html";
    }

    // ---------- Formata√ß√£o de Data (DD/MM/YYYY HH:mm:ss) ----------
    function formatarDataBR(dataStr) {
      if (!dataStr) return "";
      if (/\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}/.test(dataStr)) {
        return dataStr;
      }
      const dt = new Date(dataStr);
      if (isNaN(dt)) return dataStr;
      const pad = n => String(n).padStart(2, "0");
      return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} ` +
                            `${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
    }

    // ---------- Carregar Postes do Firebase ----------
    function carregarPostes() {
      db.ref("postes").off("value");
      db.ref("postes").on("value", snapshot => {
        const obj = snapshot.val() || {};
        const lista = Object.entries(obj)
          .filter(([, v]) => v !== null)
          .map(([id, data]) => {
            // converter dataLancamento de string para Date (campo _dataConvertida)
            if (data.dataLancamento && typeof data.dataLancamento === "string") {
              const partes = data.dataLancamento.split(/[\s/:]+/).map(Number);
              if (partes.length >= 5) {
                data._dataConvertida = new Date(partes[2], partes[1]-1, partes[0], partes[3], partes[4], partes[5]||0);
              } else {
                data._dataConvertida = null;
              }
            }
            return { id, ...data };
          });
        // ordena do mais recente para o mais antigo
        lista.sort((a, b) => (b._dataConvertida || 0) - (a._dataConvertida || 0));
        todosOsPostes = lista;
        paginaAtual = 1;
        filtrarPostes();
      });
    }

    // ---------- Normaliza√ß√£o de Texto ----------
    function normalizarTexto(txt) {
      return (txt || "").toString().trim().toLowerCase();
    }

    // ---------- Filtrar + Calcular Tempo + Paginar + Exibir (L√≥gica de Poda Adicionada) ----------
    function filtrarPostes() {
      const filtroProjeto = normalizarTexto(document.getElementById("filtroProjeto")?.value);
      const filtroPoste   = normalizarTexto(document.getElementById("filtroPoste")?.value);
      const filtroUsuario = normalizarTexto(document.getElementById("usuario")?.value);
      const filtroStatus  = normalizarTexto(document.getElementById("filtroStatus")?.value);
      const dataInicial   = document.getElementById("dataInicial").value;
      const dataFinal     = document.getElementById("dataFinal").value;

      // Filtrar
      let listaFiltrada = todosOsPostes.filter(p => {
        const data = p._dataConvertida;
        // projeto: agora usamos includes()
        const okProjeto = !filtroProjeto ||
                                normalizarTexto(p.idProjeto).includes(filtroProjeto);
        // poste: includes()
        const okPoste   = !filtroPoste ||
                                normalizarTexto(p.codigoPoste).includes(filtroPoste);
        const okUsuario = !filtroUsuario ||
                                normalizarTexto(p.usuario).includes(filtroUsuario);
        const statusNorm = normalizarTexto(p.status);
        const okStatus = !filtroStatus ||
        (filtroStatus === "em andamento"
        ? (statusNorm === "" || statusNorm === "em andamento")
        : statusNorm === filtroStatus);

        let okData = true;
        if (dataInicial) {
          const dtIni = new Date(`${dataInicial}T00:00:00`);
          okData = data instanceof Date && data >= dtIni;
        }
        if (okData && dataFinal) {
          const dtFim = new Date(`${dataFinal}T23:59:59`);
          okData = data instanceof Date && data <= dtFim;
        }
        
        // FILTRO DE PODA: Adiciona a condi√ß√£o para filtrar S√ìMENTE postes com servicosPodas="sim"
        const podasNorm = normalizarTexto(p.servicosPodas);
        const okPodas = !mostrandoSomentePodas || podasNorm === "sim";
        
        // Retorno: Combina todos os filtros, incluindo o de Poda
        return okProjeto && okPoste && okUsuario && okStatus && okData && okPodas;
      });

      // recalcula√ß√£o de tempo decorrido
      listaFiltrada.forEach(p => {
        if ((p.status || "").toLowerCase() === "em andamento") {
          p.tempoDecorrido = calcularTempoDecorrido(p.dataLancamento || "");
        } else {
          p.tempoDecorrido = null;
        }
      });

      // ordenar do mais recente para mais antigo
      listaFiltrada.sort((a, b) => (b._dataConvertida || 0) - (a._dataConvertida || 0));

      // paginar
      const totalPaginas = Math.ceil(listaFiltrada.length / itensPorPagina);
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim    = inicio + itensPorPagina;
      listaVisivel = listaFiltrada.slice(inicio, fim);

      exibirPostes(listaVisivel);
      mostrarMapa(listaVisivel);
      atualizarPaginacao(totalPaginas);
      atualizarContadorStatus();
    }

   // ---------- Atualizar Pagina√ß√£o (MODERNA) ----------
    function atualizarPaginacao(totalPaginas) {
      const pagDiv = document.getElementById("paginacao");
      pagDiv.innerHTML = "";

      if (totalPaginas <= 1) {
          // N√£o mostra a pagina√ß√£o se houver apenas uma p√°gina
          return;
      }

      const maxBotoes = 5; // N√∫mero m√°ximo de bot√µes de p√°gina para exibir
      let startPage = Math.max(1, paginaAtual - Math.floor(maxBotoes / 2));
      let endPage = Math.min(totalPaginas, startPage + maxBotoes - 1);

      if (endPage - startPage + 1 < maxBotoes) {
          startPage = Math.max(1, endPage - maxBotoes + 1);
      }
      
      // ------------------------------------
      // 1. Bot√£o ANTERIOR
      // ------------------------------------
      const btnAnterior = document.createElement("button");
      btnAnterior.textContent = "¬´ Anterior";
      btnAnterior.disabled = paginaAtual === 1;
      btnAnterior.classList.add("pagination-btn");
      btnAnterior.onclick = () => {
          paginaAtual = Math.max(1, paginaAtual - 1);
          filtrarPostes();
      };
      pagDiv.appendChild(btnAnterior);

      // ------------------------------------
      // 2. Bot√µes Num√©ricos
      // ------------------------------------
      for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.disabled = i === paginaAtual;
          btn.classList.add("pagination-page-btn");
          if (i === paginaAtual) {
              btn.classList.add("active");
          }
          btn.onclick = () => {
              paginaAtual = i;
              filtrarPostes();
          };
          pagDiv.appendChild(btn);
      }

      // ------------------------------------
      // 3. Indicador de Status (P√°gina X de Y)
      // ------------------------------------
      const spanStatus = document.createElement("span");
      spanStatus.textContent = `P√°gina ${paginaAtual} de ${totalPaginas}`;
      spanStatus.style.margin = "0 10px";
      spanStatus.style.fontWeight = "bold";
      pagDiv.appendChild(spanStatus);
      
      // ------------------------------------
      // 4. Bot√£o PR√ìXIMA
      // ------------------------------------
      const btnProxima = document.createElement("button");
      btnProxima.textContent = "Pr√≥xima ¬ª";
      btnProxima.disabled = paginaAtual === totalPaginas;
      btnProxima.classList.add("pagination-btn");
      btnProxima.onclick = () => {
          paginaAtual = Math.min(totalPaginas, paginaAtual + 1);
          filtrarPostes();
      };
      pagDiv.appendChild(btnProxima);
    }

    // Fun√ß√£o para exibir a lista de postes na tabela (RESTURADA E CORRIGIDA)
    function exibirPostes(lista) {
      const tbody = document.querySelector("#tabelaPostes tbody");
      tbody.innerHTML = "";

      lista.forEach(p => {
        const status = normalizarTexto(p.status || "em andamento");
        const tempo = p.tempoDecorrido
          ? `${p.tempoDecorrido.dias}d ${p.tempoDecorrido.horas}h`
          : "-";

        const tr = document.createElement("tr");
        tr.dataset.id = p.id;
        
        // Estrutura do TR restaurada para refletir exatamente o cabe√ßalho original.
        tr.innerHTML = `
          <td class="dataLancamento">${p.dataLancamento || ""}</td>
          <td><input class="idProjeto" type="text" value="${p.idProjeto || ""}" disabled></td>
          <td><input class="codigoPoste" type="text" value="${p.codigoPoste || ""}" disabled></td>
          <td><input class="postePrimario" type="text" value="${p.postePrimario || ""}" disabled></td>
          <td class="estruturaPrimaria">${p.estruturaPrimaria || ""}</td>
          <td class="estruturaSecundaria">${p.estruturaSecundaria || ""}</td>
          <td class="linhaViva">${p.linhaViva || ""}</td>
          <td><textarea class="servicosPodas" disabled>${p.servicosPodas || ""}</textarea></td>
          <td><textarea class="observacoes" disabled>${p.observacoes || ""}</textarea></td>
          <td class="aptaExecucao">${p.aptaExecucao || ""}</td>
          <td class="cavaRocha">${p.cavaRocha || ""}</td>
          <td class="lm">${p.lm || ""}</td>
          <td class="retroescavadeira">${p.retroescavadeira || ""}</td>
          <td><input class="latitude" type="text" value="${p.latitude || ""}" disabled></td>
          <td><input class="longitude" type="text" value="${p.longitude || ""}" disabled></td>
          <td><input class="usuario" type="text" value="${p.usuario || ""}" disabled></td>
          <td><input class="vistoriador" type="text" value="${p.vistoriador || ""}" disabled></td>
          <td><input class="cpfMorador" type="text" value="${p.cpfMorador || ""}" disabled></td>
          <td><input class="foneMorador" type="text" value="${p.foneMorador || ""}" disabled></td>
          <td><input class="luminaria" type="text" value="${p.luminaria || ""}" disabled></td>
          <td><input class="fundacaoEspecial" type="text" value="${p.fundacaoEspecial || ""}" disabled></td>
          <td><input class="guardRail" type="text" value="${p.guardRail || ""}" disabled></td>
          <td><input class="obraLPT" type="text" value="${p.obraLPT || ""}" disabled></td>
          <td><input class="monofasico" type="text" value="${p.monofasico || ""}" disabled></td>
          <td><input class="bifasico" type="text" value="${p.bifasico || ""}" disabled></td>
          <td><input class="trifasico" type="text" value="${p.trifasico || ""}" disabled></td>
          <td><input class="possuiDesligamento" type="text" value="${p.possuiDesligamento || ""}" disabled></td>
          <td><input class="quantidadeRamais" type="text" value="${p.quantidadeRamais || ""}" disabled></td>
          <td class="tempoDecorrido"><span>${tempo}</span></td>
          <td>
            <select class="status" disabled>
              <option value="em andamento" ${status==="em andamento"? "selected":""}>Em andamento</option>
              <option value="conclu√≠do" ${status==="conclu√≠do"? "selected":""}>Conclu√≠do</option>
            </select>
          </td>
          <td><button class="editar-btn">‚úèÔ∏è</button></td>
          <td><button class="delete-btn">üóëÔ∏è</button></td>
        `;

        // Eventos dos bot√µes
        tr.querySelector(".editar-btn").addEventListener("click", () => editar(tr));
        tr.querySelector(".delete-btn").addEventListener("click", () => excluir(tr));

        tbody.appendChild(tr);
      });
    }

    // Fun√ß√£o para editar um poste
    function editar(tr) {
      tr.querySelectorAll("input, textarea, select").forEach(el => el.disabled = false);
      const btn = tr.querySelector(".editar-btn");
      btn.textContent = "üíæ";
      btn.onclick = () => salvar(tr);
    }

    // Fun√ß√£o para excluir um poste
    async function excluir(tr) {
      if (!confirm("Tem certeza que deseja excluir este poste?")) return;

      const id = tr.dataset.id;

      try {
        await db.ref(`postes/${id}`).remove();
        tr.remove();
        alert("‚úÖ Poste exclu√≠do com sucesso!");
        // Recarrega a lista para atualizar o estado global
        carregarPostes(); 
      } catch (err) {
        console.error(err);
        alert(`‚ùå Falha ao excluir: ${err.message}`);
      }
    }

    // Fun√ß√£o para salvar altera√ß√µes de um poste
    async function salvar(tr) {
      const btnSalvar = tr.querySelector(".editar-btn");
      btnSalvar.disabled = true;
      btnSalvar.textContent = "üîÑ";

      const id = tr.dataset.id;

      const data = {
        dataLancamento: tr.querySelector(".dataLancamento").innerText,
        idProjeto: tr.querySelector(".idProjeto").value.trim(),
        codigoPoste: tr.querySelector(".codigoPoste").value.trim(),
        postePrimario: tr.querySelector(".postePrimario").value.trim(),
        estruturaPrimaria: tr.querySelector(".estruturaPrimaria").innerText,
        estruturaSecundaria: tr.querySelector(".estruturaSecundaria").innerText,
        linhaViva: tr.querySelector(".linhaViva").innerText,
        servicosPodas: tr.querySelector(".servicosPodas").value.trim(),
        observacoes: tr.querySelector(".observacoes").value.trim(),
        aptaExecucao: tr.querySelector(".aptaExecucao").innerText,
        cavaRocha: tr.querySelector(".cavaRocha").innerText,
        lm: tr.querySelector(".lm").innerText,
        retroescavadeira: tr.querySelector(".retroescavadeira").innerText,
        latitude: tr.querySelector(".latitude").value.trim(),
        longitude: tr.querySelector(".longitude").value.trim(),
        usuario: tr.querySelector(".usuario").value.trim(),
        vistoriador: tr.querySelector(".vistoriador").value.trim(),
        cpfMorador: tr.querySelector(".cpfMorador").value.trim(),
        foneMorador: tr.querySelector(".foneMorador").value.trim(),
        luminaria: tr.querySelector(".luminaria").value.trim(),
        fundacaoEspecial: tr.querySelector(".fundacaoEspecial").value.trim(),
        guardRail: tr.querySelector(".guardRail").value.trim(),
        obraLPT: tr.querySelector(".obraLPT").value.trim(),
        monofasico: tr.querySelector(".monofasico").value.trim(),
        bifasico: tr.querySelector(".bifasico").value.trim(),
        trifasico: tr.querySelector(".trifasico").value.trim(),
        possuiDesligamento: tr.querySelector(".possuiDesligamento").value.trim(),
        quantidadeRamais: tr.querySelector(".quantidadeRamais").value.trim(),
        status: tr.querySelector(".status").value
      };

      try {
        await db.ref(`postes/${id}`).update(data);
        alert("‚úÖ Poste atualizado com sucesso!");
        tr.querySelectorAll("input, textarea, select").forEach(el => el.disabled = true);
        btnSalvar.textContent = "‚úèÔ∏è";
        btnSalvar.onclick = () => editar(tr);
        // Recarrega a lista para atualizar o tempo decorrido no estado global
        carregarPostes();
      } catch (err) {
        console.error(err);
        alert(`‚ùå Falha ao salvar: ${err.message}`);
        btnSalvar.disabled = false;
        btnSalvar.textContent = "üíæ";
      }
    }


    function atualizarContadorStatus() {
      if (!Array.isArray(todosOsPostes) || todosOsPostes.length === 0) {
        const contador = document.getElementById("contadorStatus");
        if (contador) {
          contador.innerText = `üìö 0 projetos | üî¢ 0 postes | ‚úÖ 0 conclu√≠dos | üõ† 0 em andamento | üïí Atualizado: ${new Date().toLocaleTimeString("pt-BR")}`;
        }
        return;
      }

      // ----- Fun√ß√µes auxiliares internas -----
      function contarSimNao(campo, lista) {
        let sim = 0, nao = 0;
        lista.forEach(p => {
          const valor = (p[campo] || "").toString().trim().toLowerCase();
          // L√≥gica estrita para contar 'sim'
          if (valor === "sim") {
            sim++;
          } else {
            nao++;
          }
        });
        return { sim, nao };
      }

      function normalizarTexto(texto) {
        return (texto || "").toLowerCase().trim();
      }

      const lista = todosOsPostes;

      // ----- Contagem Sim/N√£o -----
      // Aqui usamos a contagem estrita para 'sim'
      const braco = contarSimNao("estruturaPrimaria", lista);
      // const lv = contarSimNao("linhaViva", lista); // REMOVIDO
      const poda = contarSimNao("servicosPodas", lista);

      // ----- Totais gerais -----
      const totalProj = new Set(lista.map(p => (p.idProjeto || "").trim()).filter(x => x !== "")).size;
      const totalPostes = lista.length;

      const concluidos = lista.filter(p => normalizarTexto(p.status) === "conclu√≠do").length;
      const andamento = lista.filter(p => {
        const s = normalizarTexto(p.status);
        return s === "" || s === "em andamento";
      }).length;

      // ----- Monta a mensagem (Linha Viva removida) -----
      let msg = `üìö ${totalProj} projetos | üî¢ ${totalPostes} postes | ‚úÖ ${concluidos} conclu√≠dos | üõ† ${andamento} em andamento`;
      msg += ` | Bra√ßo: Sim ${braco.sim} | N√£o ${braco.nao}`;
      // msg += ` | Linha Viva: Sim ${lv.sim} | N√£o ${lv.nao}`; // REMOVIDO
      msg += ` | Poda faixa: Sim ${poda.sim} | N√£o ${poda.nao}`;

      const agora = new Date();
      const horaAtual = agora.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
      const dataAtual = agora.toLocaleDateString("pt-BR");
      msg += ` | üïí Atualizado em: ${dataAtual} √†s ${horaAtual}`;

      // ----- Exibe no HTML -----
      const contador = document.getElementById("contadorStatus");
      if (contador) {
        contador.innerText = msg;
      } else {
        console.warn("Elemento com ID 'contadorStatus' n√£o encontrado no HTML.");
      }
    }

    // Fun√ß√£o para alternar a exibi√ß√£o do Power BI
    function togglePowerBI() {
        const main = document.getElementById("mainContent");
        const powerbi = document.getElementById("powerbiContainer");
        const btn = document.getElementById("btnPowerBI");

        if (main.style.display === 'none') {
            main.style.display = 'block';
            powerbi.style.display = 'none';
            btn.textContent = 'üìä Power BI';
        } else {
            main.style.display = 'none';
            powerbi.style.display = 'block';
            btn.textContent = '‚Üê Voltar ao Painel';
        }
    }

    // Fun√ß√£o para alternar a exibi√ß√£o de postes com Podas (L√≥gica de Linha Viva Removida)
    function togglePodas() {
        mostrandoSomentePodas = !mostrandoSomentePodas;
        document.getElementById("btnMostrarPodas").textContent = mostrandoSomentePodas 
            ? '‚úÖ Mostrar Todos' 
            : 'üåø Mostrar Podas';
        
        // A l√≥gica de desativa√ß√£o m√∫tua da Linha Viva foi removida.

        paginaAtual = 1;
        filtrarPostes(); // REAPLICA o filtro (atualiza tabela e mapa)
    }

    // FUN√á√ÉO toggleLinhaViva() FOI REMOVIDA COMPLETAMENTE.

    // ---------- Event Listener de Inicializa√ß√£o (Linha Viva Removida) ----------
    document.addEventListener('DOMContentLoaded', () => {
        // Isso √© importante para que as fun√ß√µes do escopo global estejam acess√≠veis via 'onclick'
        window.fazerLogin = fazerLogin;
        window.filtrarPostes = filtrarPostes;
        window.togglePowerBI = togglePowerBI;
        window.togglePodas = togglePodas;
        // window.toggleLinhaViva foi removido

        atualizarContadorStatus();
        if (document.getElementById("btnMostrarPodas")) {
            document.getElementById("btnMostrarPodas").textContent = 'üåø Mostrar Podas';
        }
        // O bloco 'if (document.getElementById("btnMostrarLinhaViva"))' foi removido.
        window.initMap = initMap; // Google Maps callback
    });


    // ---------- Mostrar Mapa com Markers (L√≥gica de PODA CORRIGIDA) ----------
    function mostrarMapa(lista, iconOverride = null) {
      const bounds = new google.maps.LatLngBounds();
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: { lat: -8.0, lng: -35.0 },
        gestureHandling: "greedy",
        zoomControl: true,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_RIGHT
        },
        streetViewControl: false,
        fullscreenControl: true
      });

      const geocoder = new google.maps.Geocoder();

      markers.forEach(m => {
        if (m.markerInstance) m.markerInstance.setMap(null);
        if (m.intervalId) clearInterval(m.intervalId);
      });
      markers = [];

      lista.forEach(p => {
        const lat = parseFloat(p.latitude);
        const lng = parseFloat(p.longitude);
        if (isNaN(lat) || isNaN(lng)) return;

        const status = (p.status || "").toLowerCase();
        const iconPoste = status === "em andamento" || status === ""
          ? "andamento.png"
          : "poste.png";

        const marcadorPoste = new google.maps.Marker({
          position: { lat, lng },
          map,
          title: `Poste: ${p.codigoPoste || ""}`,
          icon: {
            url: iconPoste,
            scaledSize: new google.maps.Size(32, 32)
          }
        });

      // L√ìGICA CORRIGIDA: MOSTRA √çCONE DE PODA APENAS SE FOR 'SIM'
      const podas = (p.servicosPodas || "").trim().toLowerCase();
      const temPodas = (podas === "sim"); // Apenas se o valor for exatamente "sim"

      if (temPodas) {
        const marcadorPodas = new google.maps.Marker({
          position: { lat: lat + 0.000009, lng: lng + 0.000009 },
          map,
          title: `Podas: ${p.codigoPoste || ""}`,
          icon: {
            url: "abustro.png",
            scaledSize: new google.maps.Size(18, 18)
          },
          zIndex: google.maps.Marker.MAX_ZINDEX + 1
        });
        markers.push({ markerInstance: marcadorPodas });
      }


        let infoContent = `
      <div style="max-width:270px;font-family:Roboto,sans-serif;font-size:12px;color:#333">
        <div style="background:#004d40;color:#fff;padding:12px 16px">
          <div style="font-size:16px;font-weight:600">üìÅ Projeto: ${p.idProjeto || "N/A"}</div>
          <div style="font-size:13px">üîñ PG: ${p.codigoPoste || "-"}</div>
        </div>
        <div style="padding:10px 14px;display:grid;grid-template-columns:1fr;gap:6px">
          <div>üìÖ <b>Vistoria:</b> ${p.dataLancamento || "-"}</div>
          <div>üèóÔ∏è <b>Estrutura Prim√°ria:</b> ${p.estruturaPrimaria || "-"}</div>
          <div>‚öôÔ∏è <b>Estrutura Secund√°ria:</b> ${p.estruturaSecundaria || "-"}</div>
          <div>üìç <b>Poste Prim√°rio:</b> ${p.postePrimario || "-"}</div>
          <div>üîó <b>Poste Secund√°rio:</b> ${p.posteSecundario || "-"}</div>
          <div>‚ö° <b>Linha Viva:</b> ${p.linhaViva || "-"}</div>
          <div>üí° <b>Monof√°sico:</b> ${p.monofasico || "-"}</div>
          <div>üí° <b>Bif√°sico:</b> ${p.bifasico || "-"}</div>
          <div>üí° <b>Trif√°sico:</b> ${p.trifasico || "-"}</div>
          <div>üå≥ <b>Serv. Podas:</b> ${p.servicosPodas || "N/A"}</div>
          <div>üöú <b>Retroescavadeira:</b> ${p.retroescavadeira || "N/A"}</div>
          <div>üõ†Ô∏è <b>Funda√ß√£o Especial:</b> ${p.fundacaoEspecial || "N/A"}</div>
          <div>üõ°Ô∏è <b>Guard Rail:</b> ${p.guardRail || "N/A"}</div>
          <div>üîå <b>Desligamento:</b> ${p.possuiDesligamento || "N/A"}</div>
          <div>üñáÔ∏è <b>Quantidade Ramais:</b> ${p.quantidadeRamais || "-"}</div>
          <div>üìå <b>Ramal Selecionado:</b> ${p.ramaisSelecionados || "-"}</div>
          <div>üè† <b>CPF Morador:</b> ${p.cpfMorador || "-"}</div>
          <div>üìû <b>Fone Morador:</b> ${p.foneMorador || "-"}</div>
          <div>üèóÔ∏è <b>Lumin√°ria:</b> ${p.luminaria || "-"}</div>

          <div>üèòÔ∏è <b>Obra LPT:</b> ${p.obraLPT || "N/A"}</div>
          <div>üì° <b>Lat/Lon:</b> ${p.latitude || "-"}, ${p.longitude || "-"}</div>
          <div>üìù <b>Obs.:</b> ${p.observacoes || "-"}</div>
          <div>üë§ <b>Usu√°rio:</b> ${p.usuario || "-"}</div>
          <div>üïµÔ∏è <b>Vistoriador:</b> ${p.vistoriador || "-"}</div>
          <div>üü¢ <b>Status:</b> <span style="color:${status === "conclu√≠do" ? "#2e7d32" : "#ff9800"}">${p.status || "Em andamento"}</span></div>
        </div>
      </div>`;

        const infoWindow = new google.maps.InfoWindow({ content: infoContent });
        marcadorPoste.addListener("click", () => infoWindow.open(map, marcadorPoste));

        // Adiciona o marcador principal ao array
        markers.push({ markerInstance: marcadorPoste });
        bounds.extend({ lat, lng });
      });
      
      if (lista.length > 0) {
        map.fitBounds(bounds);
        if (map.getZoom() > 15) {
          map.setZoom(15);
        }
      }
    }
</script>
</body>
</html>